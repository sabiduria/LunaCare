<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chrome AI Chatbot</title>
    <style>
        #chat{
            height: 300px;
            border : 1px solid;
            overflow-y: scroll;
        }

        #input{
            margin-top: 1rem;
            width: 50%;
        }

        @keyframes blinkingText {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #thinking {
            color: gray;
            font-style: italic;
        }
    </style>
    <script type="module">
        document.getElementById('sendMessage').addEventListener('click', sendMessage);
        import { marked } from "https://cdn.jsdelivr.net/npm/marked@13.0.3/lib/marked.esm.js";
        import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.es.mjs";
        let aiSession = null;

        async function initTextSession() {
            if (!window.ai) throw new Error('Chrome AI API not available');

            try {
                aiSession = await self.ai.languageModel.create();
                console.log('AI session created');
            } catch (error) {
                console.error('Failed to initialize AI:', error);
                addMessage('AI Response : Sorry, I am not available right now.');
            }
        }

        function showThinking() {
            const chat = document.getElementById('chat');
            const thinkingElement = document.createElement('span');
            thinkingElement.id = 'thinking';
            thinkingElement.textContent = 'Just a moment Luna is thinking...';
            thinkingElement.style.animation = 'blinkingText 1s infinite';
            chat.appendChild(thinkingElement);
        }

        function removeThinking() {
            const thinkingElement = document.getElementById('thinking');
            if (thinkingElement) thinkingElement.remove();
        }

        function addMessage(message) {
            document.getElementById('chat').innerHTML += message + '<br>';
        }

        async function sendMessage() {
            const input = document.getElementById('input');
            const message = input.value.trim();
            if (!message) return;

            //addMessage('You: ' + message);
            input.value = '';

            if (!aiSession) {
                addMessage('Sabiduria: Sorry, I am not available right now.');
                return;
            }

            showThinking(); // Show "Thinking..." before getting the response

            try {
                const response = await aiSession.prompt(message);
                removeThinking(); // Remove "Thinking..." once the response is ready
                addMessage(DOMPurify.sanitize(marked.parse(response)));
            } catch (error) {
                console.error('Error getting AI response:', error);
                removeThinking();
                addMessage('Sabiduria: Sorry, I encountered an error. Please try again.');
            }
        }

        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        initTextSession();
    </script>
</head>
<body>
    <h1>Welcome to LunaCare</h1>
    <div id="chat"></div>
    <input id="input" type="text" placeholder="Type your message...">
    <button id="sendMessage">Send</button>
</body>
</html>