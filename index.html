<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunaCare : AI Assistant</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css" >
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-thin.css">
    <link rel="stylesheet" href="style.css">
    <style>
        #chat{
            height: 80vh;
            border : 1px solid #c9c9c9;
            overflow-y: scroll;
            padding: 3%;
            background-color: rgb(255, 255, 255);
        }

        #input{
            margin-top: 1rem;
            width: 50%;
        }
        @keyframes blinkingText {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #thinking {
            color: gray;
            font-style: italic;
        }
    </style>
    <script>
        if (!isSecureContext) location.protocol = "https:";
    </script>
    <script type="module">
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        import { marked } from "https://cdn.jsdelivr.net/npm/marked@13.0.3/lib/marked.esm.js";
        import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.es.mjs";
        let aiSession = null;

        async function initTextSession() {
            if (!window.ai) throw new Error('Chrome AI API not available');

            try {
                aiSession = await self.ai.languageModel.create(
                    {
                        systemPrompt: "You are a friendly, helpful assistant specialized in health, menstruation. Provide link to different article related to your specialization when responding"
                    }
                );
                console.log('AI session created');
            } catch (error) {
                console.error('Failed to initialize AI:', error);
                addMessage('Sorry, I am not available right now.');
            }
        }

        function showThinking() {
            const chat = document.getElementById('chat');
            const thinkingElement = document.createElement('span');
            thinkingElement.id = 'thinking';
            thinkingElement.textContent = 'Just a moment Luna is thinking...';
            thinkingElement.style.animation = 'blinkingText 1s infinite';
            chat.appendChild(thinkingElement);
        }

        function removeThinking() {
            const thinkingElement = document.getElementById('thinking');
            if (thinkingElement) thinkingElement.remove();
        }

        function addMessage(message) {
            document.getElementById('chat').innerHTML += message + '<br>';
        }

        async function sendMessage() {
            const input = document.getElementById('input');
            const message = input.value.trim();
            if (!message) return;

            //addMessage('You: ' + message);
            input.value = '';

            if (!aiSession) {
                addMessage('Sorry, I am not available right now.');
                return;
            }

            showThinking(); // Show "Thinking..." before getting the response

            try {
                const response = await aiSession.prompt(message);
                removeThinking(); // Remove "Thinking..." once the response is ready
                addMessage(DOMPurify.sanitize(marked.parse(response)));
            } catch (error) {
                console.error('Error getting Luna response:', error);
                removeThinking();
                addMessage('Sorry, I encountered an error. Please try again.');
            }
        }

        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        initTextSession();

    </script>
</head>
<body>
    <div class="col-sm-6" style="height: 90vh; margin-top: 3%;">
    <div id="chat" class="col-sm-12"></div>

    <div class="publisher bt-1 border-light">
        <img class="avatar avatar-xs" src="https://img.icons8.com/color/36/000000/administrator-male.png" alt="...">
        <input id="input"  class="publisher-input" type="text" placeholder="How do you feel today?">
        <a id="sendButton" class="publisher-btn text-info" href="#" data-abc="true"><i class="fa fa-paper-plane"></i></a>
    </div>
    </div>
    <div class="col-sm-6">
        
    </div>
</body>
</html>